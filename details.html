<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³Ø¬Ù„ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø§Ù„ÙŠ v1.1.0</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --taxi: #f1c40f; --success: #27ae60; --danger: #e74c3c; --dark: #222; }
        body { font-family: 'Tajawal', sans-serif; background-color: #f4f4f4; margin: 0; padding: 20px; color: #333; }
        .details-page { max-width: 1250px; margin: auto; background: #fff; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border: 2px solid #000; }
        
        #toastBox { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; }
        .toast { background: #333; color: white; padding: 12px 25px; border-radius: 10px; font-weight: bold; border-right: 6px solid var(--taxi); margin-bottom: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); transition: 0.3s; }
        
        .header-section { text-align: center; border-bottom: 4px solid var(--taxi); margin-bottom: 25px; padding-bottom: 10px; }

        .filters-area { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; background: #fafafa; padding: 20px; border-radius: 12px; border: 1px solid #ddd; margin-bottom: 25px; }
        .filters-area label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9rem; }
        select { width: 100%; padding: 10px; border: 2px solid #ccc; border-radius: 8px; font-family: 'Tajawal'; cursor: pointer; font-weight: bold; }

        .info-wrapper { display: flex; gap: 20px; margin-bottom: 30px; }
        .info-card { flex: 1; padding: 15px; border: 3px solid #000; border-radius: 15px; text-align: center; background: #fff; }
        .info-card.rev { color: var(--success); border-color: var(--success); }
        .info-card.exp { color: var(--danger); border-color: var(--danger); }
        .info-card h3 { margin: 0; font-size: 1rem; }
        .info-card span { font-size: 1.8rem; font-weight: bold; }

        .details-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .table-section { background: #fff; border: 2px solid #333; border-radius: 10px; overflow: hidden; display: flex; flex-direction: column; }
        .table-section h2 { background: #333; color: #fff; margin: 0; padding: 12px; font-size: 1.1rem; text-align: center; }
        
        .scroll-table { max-height: 500px; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th { position: sticky; top: 0; background: #f2f2f2; padding: 12px; border-bottom: 2px solid #333; z-index: 10; }
        td { padding: 10px; text-align: center; border-bottom: 1px solid #eee; font-weight: bold; }
        tr:hover { background-color: #f9f9f9; }

        .btn-refresh { background: var(--success); color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; transition: 0.3s; }
        .btn-refresh:hover { background: #219150; }
        
        @media (max-width: 900px) { .details-container { grid-template-columns: 1fr; } .info-wrapper { flex-direction: column; } }
    </style>
</head>
<body>

<div id="toastBox"></div>

<div class="details-page">
    <div class="header-section">
        <h1>Ø³Ø¬Ù„ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø§Ù„ÙŠ v1.1.0</h1>
        <p>Ø¹Ø±Ø¶ ØªØ­Ù„ÙŠÙ„ÙŠ Ù„Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ù…ØµØ§Ø±ÙŠÙ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© (A-J)</p>
    </div>

    <div class="filters-area">
        <div><label>ğŸ“… Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù</label><select id="monthFilter" onchange="applyFilters()"></select></div>
        <div><label>ğŸ‘¤ ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø§Ù„Ùƒ</label><select id="ownerFilter" onchange="applyFilters()"><option value="all">ÙƒÙ„ Ø§Ù„Ù…Ù„Ø§Ùƒ</option></select></div>
        <div><label>ğŸ‘® Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</label><select id="inChargeFilter" onchange="applyFilters()"><option value="all">ÙƒÙ„ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ†</option></select></div>
        <div style="display:flex; align-items:flex-end;"><button class="btn-refresh" onclick="fetchData()">ØªØ­Ø¯ÙŠØ« ÙˆØ¬Ù„Ø¨ Ø§Ù„Ø³Ø¬Ù„Ø§Øª ğŸ”„</button></div>
    </div>

    <div class="info-wrapper">
        <div class="info-card rev"><h3>Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</h3><span id="sumRev">0.00</span></div>
        <div class="info-card exp"><h3>Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ (I)</h3><span id="sumExp">0.00</span></div>
        <div class="info-card"><h3>Ø§Ù„ØµØ§ÙÙŠ Ø§Ù„Ù…Ø§Ù„ÙŠ</h3><span id="sumNet">0.00</span></div>
    </div>

    <div class="details-container">
        <div class="table-section">
            <h2>ğŸ’° ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª (Ø§Ù„Ù…Ø­ØµÙ„Ø©)</h2>
            <div class="scroll-table">
                <table>
                    <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù„ÙˆØ­Ø©</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„Ø¨ÙŠØ§Ù†</th></tr></thead>
                    <tbody id="revDetails"></tbody>
                </table>
            </div>
        </div>

        <div class="table-section">
            <h2>ğŸ› ï¸ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ (Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø©)</h2>
            <div class="scroll-table">
                <table>
                    <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù„ÙˆØ­Ø©</th><th>Ø§Ù„Ù…Ø¨Ù„Øº (I)</th><th>Ø§Ù„Ù†ÙˆØ¹ ÙˆØ§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª (H+J)</th></tr></thead>
                    <tbody id="expDetails"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    const scriptUrl = "https://script.google.com/macros/s/AKfycby2xWnCceqPBlo3F-xgUikI3D4pAsx61ijcKpaxSaTTOfkOTJm_QIRMdqRvixvlDGH6kA/exec";
    let masterData = { cars: [], revenues: [], expenses: [] };

    function showToast(msg) {
        const box = document.getElementById('toastBox');
        const t = document.createElement('div'); t.className = 'toast'; t.innerText = msg;
        box.appendChild(t);
        setTimeout(() => { t.style.opacity = '0'; setTimeout(() => t.remove(), 500); }, 3000);
    }

    function genMonths() {
        const s = document.getElementById('monthFilter');
        const now = new Date();
        for(let i=0; i<12; i++) {
            const d = new Date(now.getFullYear(), now.getMonth()-i, 1);
            const label = d.toLocaleString('ar-EG', {month:'long', year:'numeric'});
            s.innerHTML += `<option value="${d.getFullYear()}-${d.getMonth()+1}">${label}</option>`;
        }
    }

    async function fetchData() {
        const savedOwner = document.getElementById('ownerFilter').value;
        const savedInCharge = document.getElementById('inChargeFilter').value;
        showToast("Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ù…Ù† Google Sheets...");
        
        try {
            const [c, r, e] = await Promise.all([
                fetch(scriptUrl,{method:'POST', body:JSON.stringify({action:'fetchTable', sheetName:'Cars'})}),
                fetch(scriptUrl,{method:'POST', body:JSON.stringify({action:'fetchTable', sheetName:'Revenues'})}),
                fetch(scriptUrl,{method:'POST', body:JSON.stringify({action:'fetchTable', sheetName:'Expenses'})})
            ]);
            masterData.cars = (await c.json()).rows;
            masterData.revenues = (await r.json()).rows;
            masterData.expenses = (await e.json()).rows;
            
            popFilters(savedOwner, savedInCharge);
            applyFilters();
            showToast("ØªÙ… Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­");
        } catch(err) { showToast("Ø®Ø·Ø£: ØªØ¹Ø°Ø± Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"); }
    }

    function popFilters(savedO, savedI) {
        const o = [...new Set(masterData.cars.map(x => String(x[2]||"").trim()))].filter(x=>x);
        const i = [...new Set(masterData.cars.map(x => String(x[3]||"").trim()))].filter(x=>x);
        
        const oFilter = document.getElementById('ownerFilter');
        const iFilter = document.getElementById('inChargeFilter');

        oFilter.innerHTML = '<option value="all">ÙƒÙ„ Ø§Ù„Ù…Ù„Ø§Ùƒ</option>' + o.map(x=>`<option value="${x}">${x}</option>`).join('');
        iFilter.innerHTML = '<option value="all">ÙƒÙ„ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ÙŠÙ†</option>' + i.map(x=>`<option value="${x}">${x}</option>`).join('');
        
        if(o.includes(savedO)) oFilter.value = savedO;
        if(i.includes(savedI)) iFilter.value = savedI;
    }

    function applyFilters() {
        const [y, m] = document.getElementById('monthFilter').value.split('-').map(Number);
        const selO = document.getElementById('ownerFilter').value;
        const selI = document.getElementById('inChargeFilter').value;

        // 1. ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù„ÙˆØ­Ø§Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø§Ù„Ùƒ ÙˆØ§Ù„Ù…Ø³Ø¤ÙˆÙ„ (Ø´ÙŠØª Cars)
        const activePlates = masterData.cars.filter(car => {
            const matchO = (selO === 'all' || String(car[2]).trim() === selO);
            const matchI = (selI === 'all' || String(car[3]).trim() === selI);
            return matchO && matchI;
        }).map(car => String(car[1]).trim());

        // 2. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª
        let rHtml = ""; let rSum = 0;
        masterData.revenues.forEach(r => {
            const d = new Date(r[1]); // DATE (B)
            const p = String(r[2]).trim(); // Car_No (C)
            if(activePlates.includes(p) && (d.getMonth()+1 === m) && (d.getFullYear() === y)) {
                const amt = parseFloat(r[5]) || 0; rSum += amt;
                rHtml += `<tr><td>${d.toLocaleDateString('en-GB')}</td><td>${p}</td><td>${amt.toFixed(2)}</td><td>${r[4]||'-'}</td></tr>`;
            }
        });

        // 3. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ (Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ø¬Ø¯ÙŠØ¯ I, H, J)
        let eHtml = ""; let eSum = 0;
        masterData.expenses.forEach(e => {
            const d = new Date(e[1]);    // DATE (B)
            const p = String(e[2]).trim(); // Car_No (C)
            
            if(activePlates.includes(p) && (d.getMonth()+1 === m) && (d.getFullYear() === y)) {
                const amt = parseFloat(e[8]) || 0; // Amount (I) -> Index 8
                const type = e[7] || "-";          // Expense_Type (H) -> Index 7
                const note = e[9] || "";           // Notes (J) -> Index 9
                eSum += amt;
                eHtml += `<tr>
                    <td>${d.toLocaleDateString('en-GB')}</td>
                    <td>${p}</td>
                    <td style="color:var(--danger)">${amt.toFixed(2)}</td>
                    <td style="text-align:right">${type} ${note ? '<br><small>('+note+')</small>' : ''}</td>
                </tr>`;
            }
        });

        document.getElementById('revDetails').innerHTML = rHtml || '<tr><td colspan="4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</td></tr>';
        document.getElementById('expDetails').innerHTML = eHtml || '<tr><td colspan="4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù…ØµØ§Ø±ÙŠÙ</td></tr>';
        document.getElementById('sumRev').innerText = rSum.toLocaleString('en-US', {minimumFractionDigits:2});
        document.getElementById('sumExp').innerText = eSum.toLocaleString('en-US', {minimumFractionDigits:2});
        document.getElementById('sumNet').innerText = (rSum - eSum).toLocaleString('en-US', {minimumFractionDigits:2});
    }

    window.onload = () => { genMonths(); fetchData(); };
</script>
</body>
</html>
